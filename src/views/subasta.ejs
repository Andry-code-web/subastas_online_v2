<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/img/footer_logo.svg" type="image/x-icon">
  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- ICON -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- STYLE -->
  <link rel="stylesheet" href="/css/style_subastas.css">
  <title>Inmueble || subasta</title>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>

  <header>
    <div class="logo"><img src="/img/logo.png" alt=""></div>
    <nav>
      <a href="/user/">Inicio</a>
      <a href="#about">About</a>
      <a href="/user/catalogo">Catalogo</a>
      <a href="/user#contacto">Contáctenos</a>
    </nav>
    <div class="session">
      <img src="/img/session.svg" alt="">
      <% if (usuario) { %>
        <p class="d-flex align-items-center ">
          <span>Bienvenido, <%= usuario.nombre %></span>
          <button class="btn_menu ms-1" id="btn_menu">
            <i class="bi bi-list"></i>
          </button>
        <div class="menu_desplegable d-flex flex-column justify-content-between">
          <div>
            <div class="cabezera_menu d-flex justify-content-between">
              <h3>Subastas</h3>
              <button id="btn_close">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            <ul>
              <li><a href="/user/logout">Logout</a></li>
              <li><a href="/user/logout">Logout</a></li>
              <li><a href="/user/logout">Logout</a></li>
            </ul>
          </div>

          <div class="perfil_user">
            <div class="d-flex flex-row">
              <img src="https://placehold.co/40x40" alt="Profile Picture" class="rounded-circle me-2">
              <div class="d-flex flex-column">
                <strong>Usuario</strong>
                <small>
                  nombre User
                </small>
                <a href="/user/logout" class="btn btn-danger btn-sm ms-2">Cerrar Sesión</a>
              </div>

            </div>

          </div>
          </p>
          <% } else { %>
            <p>
              <span>
                <a href="/user/login">Login</a>
              </span>
              <span>/</span>
              <span>
                <a href="/user/registro">Sign up</a>
              </span>
            </p>
            <% } %>
        </div>
  </header>

  <div class="detalles_subasta d-flex justify-content-center">
    <div class="property-detail">
      <!-- Carrusel e información del inmueble -->
      <div id="carouselExample<%= subasta.id %>" class="carousel slide slider">
        <div class="max-w-4xl mx-auto rounded-lg overflow-hidden content_galeria">
          <div id="imagen_principal" class="imgen_principal">
            <img class="img_principal rounded-lg" src="" alt="">
          </div>
          <div class="galeria">
            <% subasta.imagenes.forEach((imagen, index)=> { %>
              <div class="img_wrapper">
                <img class="imgs rounded-lg" src="data:image/jpeg;base64, <%= imagen %>" alt="">
              </div>
              <% }); %>
          </div>
        </div>




      </div>
      <div class="property-details-content">
        <div class="content_title">
          <h4>Información general</h4>
        </div>

        <div class="d-flex flex-column align-items-center content_info_subastas">
          <div class="nombre_tipo">
            <h3 class="d-flex justify-content-between">
              <span>Propiedad:</span>
              <span>
                <%= subasta.nombre_propiedad %>
              </span>
            </h3>
            <p class="d-flex justify-content-between">
              <span>Categoria:</span>
              <span>
                <%= subasta.categoria %>
              </span>
            </p>
          </div>

          <div class="features">
            <div class="imgenes">
              <p class="d-flex justify-content-between">
                <span>N° Baños</span>
                <span>
                  <%= subasta.N_baños %>
                </span>
              </p>
            </div>
            <div class="imgenes">
              <p class="d-flex justify-content-between">
                <span>N° Cuartos</span>
                <span>
                  <%= subasta.N_cuartos %>
                </span>
              </p>
            </div>
            <div class="imgenes">
              <p class="d-flex justify-content-between">
                <span>N° Cocinas</span>
                <span>
                  <%= subasta.N_cocina %>
                </span>
              </p>
            </div>
            <div class="imgenes">
              <p class="d-flex justify-content-between">
                <span>N° Cuartos</span>
                <span>
                  <%= subasta.N_cocheras %>
                </span>
              </p>
            </div>
            <div class="imgenes">
              <p class="d-flex justify-content-between">
                <span>Patio</span>
                <span>
                  <%= subasta.patio%>
                </span>
              </p>
            </div>
          </div>

          <div class="imagenes">
            <p class="d-flex justify-content-between">
              <span>Unicacion</span>
              <span>
                <%= subasta.direccion %>
              </span>
            </p>
          </div>

          <div class="content_descripcion">
            <h5>
              Descripcion de propiedad
            </h5>
            <p>
              <span>
                <%= subasta.descripcion %>
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>


    <div class="card">
      <div class="card-header">
        <div>
          <p>Inicia<br>VIERNES 05</p>
        </div>
        <div>
          <p>02:00 pm</p>
        </div>
      </div>
      <div class="card-body" id="body_card">
        <h2>¡Oportunidad para el que sabe!</h2>
        <button id="participar">PARTICIPA</button>
        <p class="precio">
          Precio Base:
          <span class="price">US$<%= formatNumber(subasta.precio_base) %></span>
        </p>

      </div>
      <!-- Chat de pujas -->
      <div id="chat" class="chat">
        <h3>Chat de Pujas</h3>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Ingrese su puja" />
        <button id="sendButton">Enviar</button>
      </div>
    </div>
  </div>


  <script>
    const socket = io();

    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Función para formatear números con separadores de miles
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Unirse a la sala de la subasta específica
    const auctionRoom = '<%= subasta.id %>';
    socket.emit('joinRoom', auctionRoom);

    // Obtener el precio base desde el servidor y sumar $100
    const precioBase = <%= subasta.precio_base %>;
    const precioBaseConIncremento = precioBase + 100;

    // Establecer el valor inicial del input con el precio base sumado y formateado
    messageInput.value = formatNumber(precioBaseConIncremento);

    socket.on('newBid', function (data) {
      const messageElement = document.createElement('div');
      messageElement.textContent = `Puja de $${formatNumber(data.bid)} por ${data.user}`;
      messages.appendChild(messageElement);
      messages.scrollTop = messages.scrollHeight; // Scroll to the bottom
    });

    sendButton.addEventListener('click', function () {
      const bid = messageInput.value.replace(/,/g, ''); // Eliminar comas antes de enviar
      socket.emit('bid', {
        user: '<%= usuario ? usuario.nombre : "Invitado" %>',
        bid: bid,
        room: auctionRoom
      });
      messageInput.value = '';
    });

    messageInput.addEventListener('keypress', function (event) {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });
  </script>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const botonActivar = document.getElementById("btn_menu");
      const botonCerrar = document.getElementById("btn_close");
      const contenederMenu = document.getElementsByClassName("menu_desplegable")[0];

      botonActivar.addEventListener('click', () => {
        contenederMenu.classList.add("active");
      });

      botonCerrar.addEventListener('click', () => {
        contenederMenu.classList.remove("active");
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      const mainImage = document.querySelector('#imagen_principal img');
      const galleryImages = document.querySelectorAll('.galeria .imgs');

      // Iniciar con la primera imagen de la galería
      if (galleryImages.length > 0) {
        mainImage.src = galleryImages[0].src;
        mainImage.alt = galleryImages[0].alt;
        galleryImages[0].classList.add('active'); // Añadir clase 'active' a la primera imagen
      }

      galleryImages.forEach(image => {
        image.addEventListener('click', () => {
          // Remueve la clase 'active' de todas las imágenes de la galería
          galleryImages.forEach(img => img.classList.remove('active'));

          // Agrega la clase 'active' a la imagen clicada
          image.classList.add('active');

          // Cambia la imagen y el alt de la imagen principal por los de la imagen clicada
          mainImage.src = image.src;
          mainImage.alt = image.alt;

          // Desplaza la ventana para mostrar la imagen principal
          //mainImage.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnIniciarChat = document.getElementById('participar');
      const chat = document.getElementById('chat');
      const cardBody = document.getElementById('body_card');

      btnIniciarChat.addEventListener('click', () => {
        console.log('se realizo click');
        chat.classList.add('active');
        cardBody.classList.add('active');
      });

    })
  </script>
</body>

</html>