<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/img/footer_logo.svg" type="image/x-icon">
  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- ICON -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- STYLE -->
  <link rel="stylesheet" href="/css/style_subastas.css">
  <title>Inmueble || subasta</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    #chat {
      border: 1px solid #ccc;
      padding: 10px;
      width: 300px;
      height: 400px;
      overflow-y: scroll;
    }

    #messageInput {
      width: calc(100% - 20px);
      margin: 10px 0;
    }
  </style>
</head>

<body>

  <header>
    <div class="logo"><img src="/img/logo.png" alt=""></div>
    <nav>
      <a href="/user/">Inicio</a>
      <a href="#about">About</a>
      <a href="/user/catalogo">Catalogo</a>
      <a href="#contacto">Contáctenos</a>
    </nav>
    <div class="session">
      <img src="/img/session.svg" alt="">
      <% if (usuario) { %>
      <p class="d-flex align-items-center ">
        <span>Bienvenido, <%= usuario.nombre %></span>
        <button class="btn_menu ms-1" id="btn_menu">
          <i class="bi bi-list"></i>
        </button>
      <div class="menu_desplegable d-flex flex-column justify-content-between">
        <div>
          <div class="cabezera_menu d-flex justify-content-between">
            <h3>Subastas</h3>
            <button id="btn_close">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <ul>
            <li><a href="/user/logout">Logout</a></li>
            <li><a href="/user/logout">Logout</a></li>
            <li><a href="/user/logout">Logout</a></li>
          </ul>
        </div>

        <div class="perfil_user">
          <div class="d-flex flex-row">
            <img src="https://placehold.co/40x40" alt="Profile Picture" class="rounded-circle me-2">
            <div class="d-flex flex-column">
              <strong>Usuario</strong>
              <small>
                nombre User
              </small>
              <a href="/user/logout" class="btn btn-danger btn-sm ms-2">Cerrar Sesión</a>
            </div>

          </div>

        </div>
        </p>
        <% } else { %>
        <p>
          <span>
            <a href="/user/login">Login</a>
          </span>
          <span>/</span>
          <span>
            <a href="/user/registro">Sign up</a>
          </span>
        </p>
        <% } %>
      </div>
  </header>

  <div class="detalles_subasta d-flex">
    <div class="property-detail">
      <!-- Carrusel e información del inmueble -->
      <div id="carouselExample<%= subasta.id %>" class="carousel slide slider">
        <div class="carousel-inner">
          <% subasta.imagenes.forEach((imagen, index) => { %>
          <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
            <img src="data:image/jpeg;base64,<%= imagen %>" class="d-block w-100" alt="Imagen de propiedad">
          </div>
          <% }) %>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample<%= subasta.id %>" data-bs-slide="prev">
          <span class="img_flechas" aria-hidden="true">
            <img src="/img/back_flecha.svg" alt="">
          </span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample<%= subasta.id %>" data-bs-slide="next">
          <span class="img_flechas" aria-hidden="true">
            <img src="/img/next_flecha.svg" alt="">
          </span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
      <div class="property-details-content">
        <div class="nombre_tipo">
          <h3><%= subasta.nombre_propiedad %></h3>
          <p><%= subasta.categoria.toUpperCase() %></p>
        </div>
        <p class="ubicacion">
          <%= subasta.direccion %>
        </p>
        <p class="precio">
          Precio Base:
          <span class="price">US$<%= subasta.precio_base %></span>
        </p>
        <div class="features">
          <div class="imgenes">
            <img src="/img/baño.svg" alt="">
            <p><%= subasta.N_baños %></p>
          </div>
          <div class="imgenes">
            <img src="/img/cama.svg" alt="">
            <p><%= subasta.N_cuartos %></p>
          </div>
          <div class="imgenes">
            <img src="/img/cosina.svg" alt="">
            <p><%= subasta.N_cocina %></p>
          </div>
          <div class="imgenes">
            <img src="/img/garaje.svg" alt="">
            <p><%= subasta.N_cocheras %></p>
          </div>
          <div class="imgenes">
            <img src="/img/patio.svg" alt="">
            <p><%= subasta.patio === 'si' ? '1' : '0' %></p>
          </div>
        </div>
      </div>
    </div>
    <!-- Chat de pujas -->
    <div id="chat">
      <h3>Chat de Pujas</h3>
      <div id="messages"></div>
      <input type="text" id="messageInput" placeholder="Ingrese su puja" />
      <button id="sendButton">Enviar</button>
    </div>
  </div>

  <script>
    const socket = io();

    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Unirse a la sala de la subasta específica
    const auctionRoom = '<%= subasta.id %>';
    socket.emit('joinRoom', auctionRoom);

    socket.on('newBid', function(data) {
      const messageElement = document.createElement('div');
      messageElement.textContent = `Puja de $${data.bid} por ${data.user}`;
      messages.appendChild(messageElement);
      messages.scrollTop = messages.scrollHeight; // Scroll to the bottom
    });

    sendButton.addEventListener('click', function() {
      const bid = messageInput.value;
      socket.emit('bid', {
        user: '<%= usuario ? usuario.nombre : "Invitado" %>',
        bid: bid,
        room: auctionRoom
      });
      messageInput.value = '';
    });

    messageInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const botonActivar = document.getElementById("btn_menu");
      const botonCerrar = document.getElementById("btn_close");
      const contenederMenu = document.getElementsByClassName("menu_desplegable")[0];

      botonActivar.addEventListener('click', () => {
        contenederMenu.classList.add("active");
      });

      botonCerrar.addEventListener('click', () => {
        contenederMenu.classList.remove("active");
      });
    });
  </script>
</body>

</html>